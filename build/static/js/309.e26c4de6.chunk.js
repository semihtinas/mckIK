(self.webpackChunkmuse_dashboard=self.webpackChunkmuse_dashboard||[]).push([[309],{2309:(e,a,r)=>{"use strict";r.r(a),r.d(a,{default:()=>f});var t=r(9950),n=r(6025),i=r(2460),s=r(3561),l=r(9654),o=r(6092),d=r(5355),c=r(7465),u=r(9246),y=r(4159),h=r.n(y),p=r(4028),_=r.n(p),m=r(4414);h().extend(_());const{Option:v}=n.A,{RangePicker:g}=i.A,f=e=>{var a;let{closeModal:r,onLeaveRequestSuccess:i,refreshData:y}=e;const[p,_]=(0,t.useState)([]),[f,x]=(0,t.useState)([]),[Y]=s.A.useForm(),[b,z]=(0,t.useState)(0),[k,j]=(0,t.useState)(0),[A,D]=(0,t.useState)(!1),[M,w]=(0,t.useState)({}),[S,T]=(0,t.useState)(null),[F,L]=(0,t.useState)([]),[B,q]=(0,t.useState)(0),O=u.A.create({baseURL:"http://localhost:5001",headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});(0,t.useEffect)((()=>{(async()=>{try{var e;const r=await O.get("/api/me");if(T(r.data),null!==(e=r.data)&&void 0!==e&&e.id)try{const e=await O.get(`/api/leave/leave-balance/${r.data.id}`);console.log("Leave balance response:",e.data),L(e.data)}catch(a){console.error("Error fetching leave balance:",a),l.Ay.error("\u0130zin bakiyesi y\xfcklenirken hata olu\u015ftu")}const[t,n]=await Promise.all([O.get("/api/leave-management/new-leave-types"),O.get("/api/public-holidays")]);_(t.data),x(n.data.map((e=>h()(e.holiday_date))))}catch(a){console.error("Fetch error:",a),l.Ay.error("Veriler y\xfcklenirken hata olu\u015ftu")}})()}),[]),(0,t.useEffect)((()=>{null!==S&&void 0!==S&&S.id&&(async()=>{try{const e=await O.get("/api/leave/leave-balances/summary/normal",{params:{personnel_id:null===S||void 0===S?void 0:S.id}});q(e.data.total_remaining_days)}catch(e){console.log("Fetching leave balance for:",null===S||void 0===S?void 0:S.id),console.log("Request URL:","/api/leave/leave-balances/summary/normal"),console.error("Normal izin bakiyesi y\xfcklenirken hata:",e),l.Ay.error("\u0130zin bakiyesi y\xfcklenemedi")}})()}),[S]);return(0,m.jsxs)(m.Fragment,{children:[(0,m.jsxs)(s.A,{form:Y,layout:"vertical",onFinish:e=>{const a=e.date_range;if(!a||!a[0]||!a[1])return void l.Ay.error("L\xfctfen ge\xe7erli bir tarih aral\u0131\u011f\u0131 se\xe7in");null===S||void 0===S||S.id,e.leave_type_id,a[0].format("YYYY-MM-DD"),a[1].format("YYYY-MM-DD"),e.reason;(async()=>{try{const p=M.leave_type_id;if(!M.leave_type_id)return void l.Ay.error("L\xfctfen izin t\xfcr\xfcn\xfc se\xe7iniz");if(!M.start_date||!M.end_date)return void l.Ay.error("L\xfctfen tarih aral\u0131\u011f\u0131 se\xe7iniz");if(!p)return void l.Ay.error("L\xfctfen izin t\xfcr\xfcn\xfc se\xe7iniz.");try{const u=(await O.get(`/api/leave-management/new-leave-types/${p}`)).data;if(u.conditions&&u.conditions.length>0)try{await O.post("/api/leave/check-eligibility",{personnel_id:S.id,leave_type_id:p})}catch(d){var e,a;return void l.Ay.error((null===(e=d.response)||void 0===e||null===(a=e.data)||void 0===a?void 0:a.error)||"\u0130zin ko\u015fullar\u0131 kar\u015f\u0131lanm\u0131yor")}const _={...M,personnel_id:S.id,start_date:h()(M.start_date).format("YYYY-MM-DD"),end_date:h()(M.end_date).format("YYYY-MM-DD"),status:"Pending",work_days:k,total_days:b};console.log("Formatted Values:",_);try{await O.post("/api/leave/check-balance",{personnel_id:S.id,leave_type_id:p,requested_days:k}),await O.post("/api/leave/leave-request",_),l.Ay.success("\u0130zin talebi ba\u015far\u0131yla olu\u015fturuldu"),Y.resetFields(),i&&i(),r&&r(),y&&y()}catch(c){var t,n,s;400===(null===(t=c.response)||void 0===t?void 0:t.status)?o.A.confirm({title:"Yetersiz \u0130zin Bakiyesi",content:`${c.response.data.error}. \u0130zin talebini yine de g\xf6ndermek istiyor musunuz?`,okText:"G\xf6nder",cancelText:"Vazge\xe7",onOk:async()=>{try{await O.post("/api/leave/leave-request",{..._,force_approve:!0}),l.Ay.success("\u0130zin talebi ba\u015far\u0131yla olu\u015fturuldu"),Y.resetFields(),i&&i(),r&&r(),y&&y()}catch(t){var e,a;l.Ay.error((null===(e=t.response)||void 0===e||null===(a=e.data)||void 0===a?void 0:a.error)||"\u0130zin talebi olu\u015fturulurken hata olu\u015ftu")}}}):l.Ay.error((null===(n=c.response)||void 0===n||null===(s=n.data)||void 0===s?void 0:s.error)||"\u0130zin bakiyesi kontrol\xfcnde hata olu\u015ftu")}}catch(u){return console.error("Error fetching leave type details:",u),void l.Ay.error("\u0130zin t\xfcr\xfc bilgileri al\u0131n\u0131rken hata olu\u015ftu")}}catch(p){console.error("Error:",p),l.Ay.error("\u0130zin talebi i\u015flenirken bir hata olu\u015ftu")}})()},onValuesChange:(e,a)=>{e.leave_type_id&&w((a=>({...a,leave_type_id:e.leave_type_id}))),e.reason&&w((a=>({...a,reason:e.reason})))},children:[S&&(0,m.jsx)("div",{className:"mb-4 p-4 bg-gray-50 rounded",children:(0,m.jsxs)("p",{children:[(0,m.jsx)("strong",{children:"Personel:"})," ",S.first_name," ",S.last_name]})}),B>0&&(0,m.jsxs)("div",{className:"mb-4 p-4 bg-gray-50 rounded",children:[(0,m.jsx)("h4",{children:"Toplam \u0130zin Bakiyesi"}),(0,m.jsxs)("p",{children:[(0,m.jsx)("strong",{children:"Kalan G\xfcn:"})," ",B," g\xfcn"]})]}),(()=>{if(!F||!M.leave_type_id)return null;const e=F.find((e=>e.leave_type_id===M.leave_type_id));return e?(0,m.jsxs)("div",{className:"mb-4 p-4 bg-gray-50 rounded",children:[(0,m.jsx)("h4",{children:"\u0130zin Bakiyesi"}),(0,m.jsxs)("p",{children:["Toplam \u0130zin Hakk\u0131: ",e.total_days," g\xfcn"]}),(0,m.jsxs)("p",{children:["Kullan\u0131lan \u0130zin: ",e.used_days," g\xfcn"]}),(0,m.jsxs)("p",{children:["Kalan \u0130zin: ",e.remaining_days," g\xfcn"]})]}):null})(),(0,m.jsx)(s.A.Item,{name:"leave_type_id",label:"\u0130zin T\xfcr\xfc",rules:[{required:!0,message:"L\xfctfen izin t\xfcr\xfc se\xe7in"}],children:(0,m.jsx)(n.A,{placeholder:"\u0130zin t\xfcr\xfc se\xe7in",children:p.map((e=>(0,m.jsx)(v,{value:e.id,children:e.name},e.id)))})}),(0,m.jsx)(s.A.Item,{name:"date_range",label:"\u0130zin Tarihleri",rules:[{required:!0,message:"L\xfctfen izin tarihlerini se\xe7in"}],children:(0,m.jsx)(g,{style:{width:"100%"},format:"DD.MM.YYYY",disabledDate:e=>e&&e<h()().startOf("day"),placeholder:["Ba\u015flang\u0131\xe7 Tarihi","Biti\u015f Tarihi"],onChange:e=>{if(e){const[a,r]=e;if(a&&r){const e=((e,a)=>e&&a?a.diff(e,"days")+1:0)(a,r),t=((e,a,r)=>{let t=0,n=h()(e);for(;n.isSameOrBefore(a,"day");)0!==n.day()&&6!==n.day()&&(r.some((e=>e.isSame(n,"day")))||t++),n=n.add(1,"days");return t})(a,r,f);z(e),j(t),w((e=>({...e,start_date:a,end_date:r})))}}else z(0),j(0),w((e=>({...e,start_date:null,end_date:null})))}})}),(0,m.jsxs)(s.A.Item,{children:[(0,m.jsxs)("p",{children:[(0,m.jsx)("strong",{children:"Talep edilen izin g\xfcn say\u0131s\u0131:"})," ",b," g\xfcn"]}),(0,m.jsxs)("p",{children:[(0,m.jsx)("strong",{children:"\u0130zin hakk\u0131ndan d\xfc\u015f\xfclecek i\u015f g\xfcnleri:"})," ",k," g\xfcn"]})]}),(0,m.jsx)(s.A.Item,{name:"reason",label:"\u0130zin Nedeni",rules:[{required:!0,message:"L\xfctfen izin nedeni girin"}],children:(0,m.jsx)(d.A.TextArea,{rows:4,placeholder:"\u0130zin nedeni yaz\u0131n"})}),(0,m.jsx)(s.A.Item,{children:(0,m.jsx)(c.Ay,{type:"primary",htmlType:"submit",children:"Talep G\xf6nder"})})]}),(0,m.jsxs)(o.A,{title:"\u0130zin Talebini Onayla",open:A,onOk:async()=>{try{const e={...M,personnel_id:S.id,start_date:M.start_date&&h()(M.start_date).isValid()?h()(M.start_date).format("YYYY-MM-DD"):null,end_date:M.end_date&&h()(M.end_date).isValid()?h()(M.end_date).format("YYYY-MM-DD"):null,status:"Pending",work_days:k,total_days:b};console.log("Sending work_days value:",e.work_days),console.log("Sending total_days value:",e.total_days),console.log("Formatted start_date:",h()(M.start_date).format("YYYY-MM-DD")),console.log("Formatted end_date:",h()(M.end_date).format("YYYY-MM-DD")),await O.post("/api/leave/leave-request",e),l.Ay.success("\u0130zin talebi ba\u015far\u0131yla olu\u015fturuldu"),Y.resetFields(),D(!1),i&&i(),r&&r(),y&&y()}catch(e){console.error("Submit error:",e),l.Ay.error("\u0130zin talebi olu\u015fturulurken hata olu\u015ftu")}},onCancel:()=>D(!1),okText:"Onayla",cancelText:"\u0130ptal",children:[(0,m.jsxs)("p",{children:[(0,m.jsx)("strong",{children:"\u0130zin T\xfcr\xfc:"})," ",null===(a=p.find((e=>e.id===M.leave_type_id)))||void 0===a?void 0:a.name]}),(0,m.jsxs)("p",{children:[(0,m.jsx)("strong",{children:"\u0130zin Tarihleri:"})," ",M.start_date&&M.end_date?`${h()(M.start_date).format("DD.MM.YYYY")} - ${h()(M.end_date).format("DD.MM.YYYY")}`:"Belirtilmemi\u015f"]}),(0,m.jsxs)("p",{children:[(0,m.jsx)("strong",{children:"Talep edilen izin g\xfcn say\u0131s\u0131:"})," ",b," g\xfcn"]}),(0,m.jsxs)("p",{children:[(0,m.jsx)("strong",{children:"\u0130\u015f g\xfcnleri:"})," ",k," g\xfcn"]}),(0,m.jsxs)("p",{children:[(0,m.jsx)("strong",{children:"\u0130zin Nedeni:"})," ",M.reason]})]})]})}},4028:function(e){e.exports=function(){"use strict";return function(e,a){a.prototype.isSameOrBefore=function(e,a){return this.isSame(e,a)||this.isBefore(e,a)}}}()}}]);